---
title: TiDB Backup & Restore Overview
summary: Learn about the definition and features of TiDB Backup & Restore.
---

# TiDB バックアップ＆リストアの概要 {#tidb-backup-restore-overview}

Raftプロトコルと適切なデプロイメントトポロジに基づいて、TiDBはクラスタの高可用性を実現します。クラスタ内の数ノードが故障した場合でも、クラスタは引き続き利用可能です。この基礎の上で、さらにデータの安全性を確保するために、TiDBはディザスタリカバリ（BR）機能を提供し、自然災害や誤操作からデータを回復する最終手段としています。

BRは以下の要件を満たします：

- クラスタデータをディザスタリカバリ（DR）システムにバックアップし、RPOを5分まで短縮して、災害シナリオでのデータ損失を減らします。
- アプリケーションからの誤操作の場合に、エラーイベントの前の時点にデータをロールバックして処理します。
- 司法監督の要件を満たすために、履歴データの監査を実行します。
- トラブルシューティング、パフォーマンスチューニング、シミュレーションテストに便利な本番環境のクローンを作成します。

## 使用前 {#before-you-use}

このセクションでは、TiDBのバックアップとリストアの使用に先立つ前提条件について、制限、使用上のヒント、互換性の問題について説明します。

### 制限 {#restrictions}

- PITRは**空のクラスタ**にのみデータをリストアすることをサポートします。
- PITRはクラスタレベルのリストアのみをサポートし、データベースレベルやテーブルレベルのリストアをサポートしません。
- PITRはユーザーテーブルや権限テーブルのデータをシステムテーブルからリストアすることをサポートしません。
- BRはクラスタで**同時に複数のバックアップタスクを実行する**ことをサポートしません。
- PITRが実行中の場合、ログバックアップタスクを実行したり、TiCDCを使用してデータをダウンストリームクラスタにレプリケートすることはできません。

### いくつかのヒント {#some-tips}

スナップショットバックアップ：

- アプリケーションへの影響を最小限に抑えるために、オフピーク時にバックアップ操作を実行することをお勧めします。
- 複数のバックアップまたはリストアタスクを1つずつ実行することをお勧めします。複数のバックアップタスクを並行して実行すると、パフォーマンスが低下します。さらに、複数のタスク間の連携が不足すると、タスクの失敗が発生し、クラスタのパフォーマンスに影響を与える可能性があります。

スナップショットリストア：

- BRは可能な限りターゲットクラスタのリソースを使用します。そのため、新しいクラスタやオフラインクラスタにデータをリストアすることをお勧めします。本番クラスタにデータをリストアしないでください。そうしないと、アプリケーションに必然的に影響が出ます。

バックアップストレージとネットワーク構成：

- Amazon S3、GCS、またはAzure Blob Storageと互換性のあるストレージシステムにバックアップデータを保存することをお勧めします。
- BR、TiKV、およびバックアップストレージシステムが十分なネットワーク帯域幅を持ち、バックアップおよびリストア中にパフォーマンスボトルネックにならないようにする必要があります。

## バックアップとリストアの使用 {#use-backup-and-restore}

BRの使用方法は、TiDBのデプロイメント方法によって異なります。このドキュメントでは、オンプレミスデプロイメントでのTiDBクラスタデータのバックアップとリストアにbrコマンドラインツールを使用する方法について紹介します。

他のデプロイメントシナリオでこの機能を使用する方法については、次のドキュメントを参照してください：

- [TiDB Cloudで展開されたTiDBのバックアップとリストア](https://docs.pingcap.com/tidbcloud/backup-and-restore)：[TiDB Cloud](https://www.pingcap.com/tidb-cloud/?from=en)でTiDBクラスタを作成することをお勧めします。TiDB Cloudは、アプリケーションに集中できるようにフルマネージドデータベースを提供します。
- [TiDB Operatorを使用したデータのバックアップとリストア](https://docs.pingcap.com/tidb-in-kubernetes/stable/backup-restore-overview)：Kubernetes上でTiDB Operatorを使用してTiDBクラスタを展開する場合、Kubernetes CustomResourceDefinition（CRD）を使用してデータのバックアップとリストアを行うことをお勧めします。

## BRの機能 {#br-features}

TiDB BRは以下の機能を提供します：

- クラスタデータのバックアップ：特定の時点でクラスタのフルデータ（**フルバックアップ**）をバックアップするか、TiDBのデータ変更（TiKVでのKV変更を意味する**ログバックアップ**）をバックアップすることができます。

- バックアップデータのリストア：

  - フルバックアップを**リストア**するか、フルバックアップ内の特定のデータベースやテーブルを**リストア**することができます。
  - バックアップデータ（フルバックアップおよびログバックアップ）に基づいて、ターゲットクラスタをバックアップクラスタの任意の時点にリストアすることができます。このタイプのリストアは、ポイントインタイムリカバリ（PITR）と呼ばれます。

### クラスタデータのバックアップ {#back-up-cluster-data}

フルバックアップは、特定の時点でクラスタのすべてのデータをバックアップします。TiDBは、次の方法のフルバックアップをサポートしています。

- クラスタスナップショットのバックアップ：TiDBクラスタのスナップショットには、特定の時点でトランザクション的に整合したデータが含まれています。詳細については、[スナップショットバックアップ](/br/br-snapshot-guide.md#back-up-cluster-snapshots)を参照してください。

フルバックアップは多くのストレージスペースを占有し、特定の時点でのクラスタデータのみを含んでいます。復元ポイントを必要に応じて選択したい場合、つまり、時間指定のリカバリ（PITR）を実行したい場合は、同時に次の2つのバックアップ方法を使用できます。

- [ログバックアップ](/br/br-pitr-guide.md#start-log-backup)を開始します。ログバックアップが開始されると、タスクはすべてのTiKVノードで実行され、指定されたストレージにTiDBの増分データを定期的に小分けにしてバックアップします。
- 定期的にスナップショットバックアップを実行します。たとえば、毎日午前0時にクラスタ全体のデータをバックアップストレージにバックアップします。

#### バックアップのパフォーマンスとTiDBクラスタへの影響 {#backup-performance-and-impact-on-tidb-clusters}

- クラスタのCPUおよびI/Oリソースが十分な場合、スナップショットバックアップはTiDBクラスタにほとんど影響を与えず、一般的に20%以下にとどまります。適切なTiDBクラスタの構成により、この影響をさらに10%またはそれ以下に抑えることができます。CPUおよびI/Oリソースが不十分な場合は、TiKV構成項目[`backup.num-threads`](/tikv-configuration-file.md#num-threads-1)を調整して、バックアップタスクのTiDBクラスタへの影響を軽減するために使用するワーカースレッドの数を変更できます。 TiKVノードのバックアップ速度はスケーラブルで、50 MB/sから100 MB/sまでの範囲があります。詳細については、[バックアップのパフォーマンスと影響](/br/br-snapshot-guide.md#performance-and-impact-of-snapshot-backup)を参照してください。
- ログバックアップタスクのみがある場合、クラスタへの影響は約5%です。ログバックアップは、最後のリフレッシュ後に生成されたすべての変更を3〜5分ごとにバックアップストレージにフラッシュし、\*\*5分という短いリカバリポイントオブジェクティブ（RPO）\*\*を達成できます。

### バックアップデータのリストア {#restore-backup-data}

バックアップ機能に対応して、フルリストアとPITRの2種類のリストアを実行できます。

- フルバックアップのリストア

  - クラスタスナップショットバックアップのリストア：スナップショットバックアップデータを空のクラスタまたはデータの競合がないクラスタ（スキーマまたはテーブルが同じ）にリストアできます。詳細については、[スナップショットバックアップのリストア](/br/br-snapshot-guide.md#restore-cluster-snapshots)を参照してください。また、バックアップデータから特定のデータベースやテーブルをリストアし、不要なデータをフィルタリングすることもできます。詳細については、[バックアップデータから特定のデータベースやテーブルをリストア](/br/br-snapshot-guide.md#restore-a-database-or-a-table)を参照してください。

- 任意の時点でデータをリストア（PITR）

  - `br restore point`コマンドを実行することで、リカバリ時点の直前の最新のスナップショットバックアップデータと指定された時刻までのログバックアップデータをリストアできます。BRは自動的にリストア範囲を決定し、バックアップデータにアクセスし、データをターゲットクラスタに順次リストアします。

#### リストアのパフォーマンスとTiDBクラスタへの影響 {#restore-performance-and-impact-on-tidb-clusters}

- データのリストアはスケーラブルな速度で実行されます。一般的に、速度はTiKVノードあたり100 MiB/sです。`br`は新しいクラスタにデータをリストアするだけであり、可能な限りターゲットクラスタのリソースを使用します。詳細については、[リストアのパフォーマンスと影響](/br/br-snapshot-guide.md#performance-and-impact-of-snapshot-restore)を参照してください。
- 各TiKVノードでは、PITRは30 GiB/hでログデータをリストアできます。詳細については、[PITRのパフォーマンスと影響](/br/br-pitr-guide.md#performance-and-impact-of-pitr)を参照してください。

## バックアップストレージ {#backup-storage}

TiDBは、Amazon S3、Google Cloud Storage（GCS）、Azure Blob Storage、NFS、およびその他のS3互換のファイルストレージサービスにデータをバックアップすることをサポートしています。詳細については、次のドキュメントを参照してください。

- [URIでバックアップストレージを指定](/external-storage-uri.md)
- [バックアップストレージへのアクセス権限を構成](/br/backup-and-restore-storages.md#authentication)

## 互換性" {#compatibility}

### 他の機能との互換性 {#compatibility-with-other-features}

バックアップとリストアは、TiDBの機能が有効または無効になっているときに問題が発生する可能性があります。これらの機能がバックアップとリストア中に一貫して有効または無効になっていない場合、互換性の問題が発生する可能性があります。

| 機能                    | 問題                                               | 解決策                                                                                                                                                                                                                                                                                                                                                                          |
| --------------------- | ------------------------------------------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| GBK文字セット              |                                                  | v5.4.0より前のバージョンのBRは、`charset=GBK`のテーブルのリストアをサポートしていません。BRのどのバージョンも、v5.4.0より前のTiDBクラスタに`charset=GBK`のテーブルを復元することはサポートしていません。                                                                                                                                                                                                                                                  |
| クラスタ化インデックス           | [#565](https://github.com/pingcap/br/issues/565) | リストア中の`tidb_enable_clustered_index`グローバル変数の値がバックアップ中と一致していることを確認してください。そうでない場合、`default not found`エラーやデータインデックスの不整合などのデータ不整合が発生する可能性があります。                                                                                                                                                                                                                                   |
| 新しい照合順序               | [#352](https://github.com/pingcap/br/issues/352) | リストア中の`mysql.tidb`テーブルの`new_collation_enabled`変数の値がバックアップ中と一致していることを確認してください。そうでない場合、データインデックスの不整合が発生し、チェックサムが通過しない可能性があります。詳細については、[FAQ - BRが`new_collations_enabled_on_first_bootstrap`の不一致を報告する理由](/faq/backup-and-restore-faq.md#why-is-new_collation_enabled-mismatch-reported-during-restore)を参照してください。                                                                |
| グローバル一時テーブル           |                                                  | バックアップとリストアにはv5.3.0以降のBRを使用していることを確認してください。そうでない場合、バックアップされたグローバル一時テーブルの定義にエラーが発生します。                                                                                                                                                                                                                                                                                        |
| TiDB Lightning物理インポート |                                                  | 上流データベースがTiDB Lightningの物理インポートモードを使用している場合、ログバックアップでデータをバックアップすることはできません。データインポート後にフルバックアップを実行することをお勧めします。詳細については、[上流データベースがTiDB Lightningを物理インポートモードでデータをインポートすると、ログバックアップ機能が利用できなくなる理由](/faq/backup-and-restore-faq.md#when-the-upstream-database-imports-data-using-tidb-lightning-in-the-physical-import-mode-the-log-backup-feature-becomes-unavailable-why)を参照してください。 |

### バージョンの互換性 {#version-compatibility}

> **Note:**
>
> バックアップとリストアには、TiDBクラスタと同じメジャーバージョンのBRを使用することをお勧めします。

バックアップとリストアを実行する前に、BRはTiDBクラスタのバージョンと自身のバージョンを比較し、互換性をチェックします。バージョンが互換性がない場合、BRはエラーを報告して終了します。バージョンチェックを強制的にスキップするには、`--check-requirements=false`を設定できます。ただし、バージョンチェックをスキップすると、データの互換性が損なわれる可能性があります。

v7.0.0以降、TiDBはSQLステートメントを使用してバックアップとリストア操作を段階的にサポートしています。そのため、クラスタデータのバックアップとリストアを実行する際には、TiDBクラスタと同じメジャーバージョンのBRツールを使用し、メジャーバージョンをまたいだデータのバックアップとリストア操作を避けることを強くお勧めします。これにより、リストア操作のスムーズな実行とデータの整合性が確保されます。

TiDB v6.6.0より前のBRの互換性情報は次のとおりです。

| バックアップバージョン（縦） \ リストアバージョン（横）                        | TiDB v6.0にリストア                                                                                                  | TiDB v6.1にリストア | TiDB v6.2にリストア | TiDB v6.3、v6.4、またはv6.5にリストア | TiDB v6.6にリストア           |
| ---------------------------------------------------- | --------------------------------------------------------------------------------------------------------------- | -------------- | -------------- | --------------------------- | ------------------------ |
| TiDB v6.0、v6.1、v6.2、v6.3、v6.4、またはv6.5 スナップショットバックアップ | 互換性あり（既知の問題[#36379](https://github.com/pingcap/tidb/issues/36379)：バックアップデータに空のスキーマが含まれる場合、BRはエラーを報告する可能性があります。） | 互換性あり          | 互換性あり          | 互換性あり                       | 互換性あり（BRはv6.6である必要があります） |
| TiDB v6.3、v6.4、v6.5、またはv6.6 ログバックアップ                 | 互換性なし                                                                                                           | 互換性なし          | 互換性なし          | 互換性あり                       | 互換性あり                    |

## 関連項目 {#see-also}

- [TiDBスナップショットバックアップとリストアガイド](/br/br-snapshot-guide.md)
- [TiDBログバックアップとPITRガイド](/br/br-pitr-guide.md)
- [バックアップストレージ](/br/backup-and-restore-storages.md)
