---
title: TiDB Backup & Restore Overview
summary: Learn about the definition and features of TiDB Backup & Restore.
---

# TiDB バックアップ＆リストアの概要 {#tidb-backup-restore-overview}

Raft プロトコルと適切な展開トポロジに基づいて、TiDB はクラスタの高可用性を実現します。クラスタ内の数ノードが故障しても、クラスタは引き続き利用可能です。この基盤の上で、さらにデータの安全性を確保するために、TiDB はバックアップ＆リストア（BR）機能を提供し、自然災害や誤操作からデータを回復する最終手段としています。

BR は以下の要件を満たします：

-   クラスタデータを災害復旧（DR）システムに 5 分という短い RPO でバックアップし、災害シナリオでのデータ損失を減らします。
-   アプリケーションの誤操作の場合にデータをエラーイベントの前の時点にロールバックします。
-   司法監督の要件を満たすために履歴データの監査を実行します。
-   トラブルシューティング、パフォーマンスチューニング、シミュレーションテストに便利な本番環境のクローンを作成します。

## 使用前の注意事項 {#before-you-use}

このセクションでは、TiDB バックアップとリストアの使用に必要な前提条件について、制限、使用上のヒント、互換性の問題などを説明します。

### 制限事項 {#restrictions}

-   PITR は**空のクラスタ**にのみデータをリストアできます。
-   PITR はクラスタレベルのリストアのみをサポートし、データベースレベルやテーブルレベルのリストアをサポートしません。
-   PITR はユーザーテーブルや権限テーブルのデータをシステムテーブルからリストアすることをサポートしません。
-   BR はクラスタで**同時に複数のバックアップタスクを実行することをサポートしません**。
-   PITR が実行中の場合、ログバックアップタスクを実行したり、TiCDC を使用してデータをダウンストリームクラスタにレプリケートすることはできません。

### いくつかのヒント {#some-tips}

スナップショットバックアップ：

-   アプリケーションへの影響を最小限に抑えるために、オフピーク時にバックアップ操作を実行することを推奨します。
-   複数のバックアップまたはリストアタスクを一つずつ実行することを推奨します。複数のバックアップタスクを並行して実行すると、パフォーマンスが低下します。さらに、複数のタスク間の連携が不足すると、タスクの失敗が発生し、クラスタのパフォーマンスに影響を与える可能性があります。

スナップショットリストア：

-   BR は可能な限りターゲットクラスタのリソースを使用します。したがって、新しいクラスタやオフラインクラスタにデータをリストアすることを推奨します。本番クラスタにデータをリストアしないでください。そうしないと、アプリケーションに必然的に影響が出ます。

バックアップストレージとネットワーク構成：

-   Amazon S3、GCS、または Azure Blob Storage と互換性のあるストレージシステムにバックアップデータを保存することを推奨します。
-   BR、TiKV、およびバックアップストレージシステムが十分なネットワーク帯域幅を持ち、バックアップおよびリストア中にパフォーマンスボトルネックにならないようにする必要があります。また、バックアップストレージシステムが十分な読み書きパフォーマンス（IOPS）を提供できることも確認する必要があります。

## バックアップとリストアの使用 {#use-backup-and-restore}

TiDB の展開方法によって、BR の使用方法は異なります。このドキュメントでは、オンプレミス展開で br コマンドラインツールを使用して TiDB クラスタデータをバックアップおよびリストアする方法について紹介します。

他の展開シナリオでこの機能を使用する方法については、以下のドキュメントを参照してください：

-   [TiDB Cloud に展開された TiDB のバックアップとリストア](https://docs.pingcap.com/tidbcloud/backup-and-restore): [TiDB Cloud](https://www.pingcap.com/tidb-cloud/?from=en) で TiDB クラスタを作成することをお勧めします。TiDB Cloud は、完全に管理されたデータベースを提供し、アプリケーションに集中できるようにします。
-   [TiDB Operator を使用したデータのバックアップとリストア](https://docs.pingcap.com/tidb-in-kubernetes/stable/backup-restore-overview): Kubernetes 上で TiDB Operator を使用して TiDB クラスタを展開する場合、Kubernetes CustomResourceDefinition（CRD）を使用してデータのバックアップとリストアを行うことをお勧めします。

## BR の機能 {#br-features}

TiDB BR は以下の機能を提供します：

-   クラスタデータのバックアップ：特定の時点でクラスタの全データ（**フルバックアップ**）をバックアップしたり、TiDB のデータ変更（TiKV での KV 変更を指す**ログバックアップ**）をバックアップできます。

-   バックアップデータのリストア：

    -   **フルバックアップ**または**特定のデータベースやテーブル**をフルバックアップからリストアできます。
    -   バックアップデータ（フルバックアップおよびログバックアップ）に基づいて、ターゲットクラスタをバックアップクラスタの任意の時点にリストアできます。この種類のリストアは、時間指定リカバリ（PITR）と呼ばれます。

### クラスタデータのバックアップ {#back-up-cluster-data}

フルバックアップは特定の時点でクラスタの全データをバックアップします。TiDB は以下の方法のフルバックアップをサポートしています：

-   クラスタスナップショットのバックアップ：TiDB クラスタのスナップショットには特定時点でのトランザクション

-   [ログバックアップ](/br/br-pitr-guide.md#start-log-backup)を開始します。ログバックアップが開始されると、すべての TiKV ノードでタスクが実行され、指定されたストレージに定期的に TiDB の増分データを小さなバッチでバックアップします。

-   定期的にスナップショットバックアップを実行します。例えば、毎日午前0時にクラスタ全体のデータをバックアップストレージにバックアップする、クラスタスナップショットバックアップを実行します。

#### バックアップのパフォーマンスと TiDB クラスタへの影響 {#backup-performance-and-impact-on-tidb-clusters}

-   クラスタ内の CPU および I/O リソースが十分な場合、スナップショットバックアップは通常 TiDB クラスタにほとんど影響を与えず、一般的に 20% 以下にとどまります。TiDB クラスタの適切な構成により、この影響をさらに最小限に抑えて 10% 以下にすることができます。CPU および I/O リソースが不十分な場合、TiKV 構成項目 [`backup.num-threads`](/tikv-configuration-file.md#num-threads-1) を調整して、バックアップタスクが TiDB クラスタに与える影響を軽減するために使用するワーカースレッドの数を変更できます。TiKV ノードのバックアップ速度はスケーラブルで、50 MB/s から 100 MB/s の範囲になります。詳細については、[バックアップのパフォーマンスと影響](/br/br-snapshot-guide.md#performance-and-impact-of-snapshot-backup)を参照してください。
-   ログバックアップタスクのみが存在する場合、クラスタへの影響は約 5% です。ログバックアップは、最後のリフレッシュ後に生成されたすべての変更を 3〜5 分ごとにバックアップストレージにフラッシュし、**5 分という短い回復目標（RPO）を達成**できます。

### バックアップデータの復元 {#restore-backup-data}

バックアップ機能に対応して、完全な復元と PITR の 2 種類の復元を実行できます。

-   完全バックアップの復元

    -   クラスタスナップショットバックアップの復元: スナップショットバックアップデータを空のクラスタまたはデータの競合がないクラスタ（同じスキーマまたはテーブルを持つ）に復元できます。詳細については、[スナップショットバックアップの復元](/br/br-snapshot-guide.md#restore-cluster-snapshots)を参照してください。また、バックアップデータから特定のデータベースやテーブルを復元し、不要なデータをフィルタリングすることもできます。詳細については、[バックアップデータから特定のデータベースやテーブルを復元](/br/br-snapshot-guide.md#restore-a-database-or-a-table)を参照してください。

-   任意の時点でのデータ復元（PITR）

    -   `br restore point` コマンドを実行することで、回復時点の直前の最新のスナップショットバックアップデータと指定された時刻のログバックアップデータを復元できます。BR は自動的に復元範囲を決定し、バックアップデータにアクセスし、データを対象クラスタに順次復元します。

#### TiDB クラスタへの復元のパフォーマンスと影響 {#restore-performance-and-impact-on-tidb-clusters}

-   データの復元はスケーラブルな速度で実行されます。一般的に、TiKV ノードごとに速度は 100 MiB/s です。`br` は新しいクラスタにのみデータを復元し、可能な限り対象クラスタのリソースを使用します。詳細については、[復元のパフォーマンスと影響](/br/br-snapshot-guide.md#performance-and-impact-of-snapshot-restore)を参照してください。
-   各 TiKV ノードでは、PITR は 30 GiB/h の速度でログデータを復元できます。詳細については、[PITR のパフォーマンスと影響](/br/br-pitr-guide.md#performance-and-impact-of-pitr)を参照してください。

## バックアップストレージ {#backup-storage}

TiDB は、Amazon S3、Google Cloud Storage（GCS）、Azure Blob Storage、NFS、およびその他の S3 互換のファイルストレージサービスにデータをバックアップすることをサポートしています。詳細については、以下のドキュメントを参照してください：

-   [URI でバックアップストレージを指定](/external-storage-uri.md)
-   [バックアップストレージへのアクセス権限の構成](/br/backup-and-restore-storages.md#authentication)

## 互換性 {#compatibility}

### 他の機能との互換性 {#compatibility-with-other-features}

バックアップと復元は、一部の TiDB 機能が有効または無効になっている場合にはうまくいかないことがあります。これらの機能がバックアップと復元中に一貫して有効または無効になっていない場合、互換性の問題が発生する可能性があります。

| 機能                    | 問題                                               | 解決策                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| --------------------- | ------------------------------------------------ | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| GBK文字セット              |                                                  | v5.4.0より前のバージョンのBRは、`charset=GBK`テーブルの復元をサポートしていません。また、v5.4.0より前のTiDBクラスターに`charset=GBK`テーブルを復元するバージョンのBRはありません。                                                                                                                                                                                                                                                                                                                                   |
| クラスター化インデックス          | [#565](https://github.com/pingcap/br/issues/565) | リストア時の`tidb_enable_clustered_index`グローバル変数の値がバックアップ時と一貫していることを確認してください。そうでない場合、`default not found`エラーやデータインデックスの不整合などのデータ不整合が発生する可能性があります。                                                                                                                                                                                                                                                                                                         |
| 新しい照合順序               | [#352](https://github.com/pingcap/br/issues/352) | リストア時の`mysql.tidb`テーブルの`new_collation_enabled`変数の値がバックアップ時と一貫していることを確認してください。そうでない場合、データインデックスの不整合やチェックサムの合格不可が発生する可能性があります。詳細については、[FAQ - Why does BR report `new_collations_enabled_on_first_bootstrap` mismatch?](/faq/backup-and-restore-faq.md#why-is-new_collation_enabled-mismatch-reported-during-restore)を参照してください。                                                                                                                       |
| グローバル一時テーブル           |                                                  | データのバックアップとリストアには、v5.3.0以降のバージョンのBRを使用してください。そうでない場合、バックアップされたグローバル一時テーブルの定義にエラーが発生します。                                                                                                                                                                                                                                                                                                                                                            |
| TiDB Lightning物理インポート |                                                  | アップストリームデータベースがTiDB Lightningの物理インポートモードを使用している場合、データはログバックアップでバックアップできません。データインポート後にフルバックアップを実行することをお勧めします。詳細については、[When the upstream database imports data using TiDB Lightning in the physical import mode, the log backup feature becomes unavailable. Why?](/faq/backup-and-restore-faq.md#when-the-upstream-database-imports-data-using-tidb-lightning-in-the-physical-import-mode-the-log-backup-feature-becomes-unavailable-why)を参照してください。 |

### バージョンの互換性 {#version-compatibility}

> **注意:**
>
> バックアップとリストアには、TiDBクラスターと同じメジャーバージョンのBRを使用することをお勧めします。

バックアップとリストアを実行する前に、BRはTiDBクラスターのバージョンと自身のバージョンを比較し、互換性をチェックします。バージョンが互換性がない場合、BRはエラーを報告して終了します。バージョンチェックを強制的にスキップするには、`--check-requirements=false`を設定できます。バージョンチェックをスキップすると、データの非互換性が発生する可能性があることに注意してください。

v7.0.0から、TiDBはSQLステートメントを使用してバックアップとリストア操作を段階的にサポートしています。そのため、クラスターデータのバックアップとリストア操作を実行する際には、TiDBクラスターと同じメジャーバージョンのBRツールを使用し、メジャーバージョンを跨いでデータのバックアップとリストア操作を行わないように強くお勧めします。これにより、リストア操作のスムーズな実行とデータの整合性が確保されます。

TiDB v6.6.0より前のBRの互換性情報は以下の通りです:

| バックアップバージョン（縦） \ リストアバージョン（横）                        | TiDB v6.0にリストア                                                                                                    | TiDB v6.1にリストア | TiDB v6.2にリストア | TiDB v6.3、v6.4、またはv6.5にリストア | TiDB v6.6にリストア           |
| ---------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------- | -------------- | -------------- | --------------------------- | ------------------------ |
| TiDB v6.0、v6.1、v6.2、v6.3、v6.4、またはv6.5 スナップショットバックアップ | 互換性あり（既知の問題 [#36379](https://github.com/pingcap/tidb/issues/36379): バックアップデータに空のスキーマが含まれる場合、BRはエラーを報告する可能性があります。） | 互換性あり          | 互換性あり          | 互換性あり                       | 互換性あり（BRはv6.6である必要があります） |
| TiDB v6.3、v6.4、v6.5、またはv6.6 ログバックアップ                 | 互換性なし                                                                                                             | 互換性なし          | 互換性なし          | 互換性あり                       | 互換性あり                    |

## 関連情報 {#see-also}

-   [TiDB スナップショットバックアップとリストアガイド](/br/br-snapshot-guide.md)
-   [TiDB ログバックアップとPITRガイド](/br/br-pitr-guide.md)
-   [バックアップストレージ](/br/backup-and-restore-storages.md)
