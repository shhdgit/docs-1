---
title: Database Audit Logging
summary: Learn about how to audit a cluster in TiDB Cloud.
---

# データベース監査ログ {#database-audit-logging}

TiDB Cloudは、ユーザーアクセスの詳細（実行されたSQLステートメントなど）の履歴を記録するデータベース監査ログ機能を提供します。

> **Note:**
>
> 現在、データベース監査ログ機能はリクエストによってのみ利用可能です。この機能をリクエストするには、[TiDB Cloudコンソール](https://tidbcloud.com)の右下隅の\*\*?**をクリックし、**サポートをリクエスト**をクリックします。その後、「データベース監査ログの申請」を**説明\*\*フィールドに記入し、**送信**をクリックします。

組織のユーザーアクセスポリシーやその他の情報セキュリティ対策の効果を評価するために、データベース監査ログの定期的な分析を行うことはセキュリティのベストプラクティスです。

監査ログ機能はデフォルトで無効になっています。クラスターを監査するには、まず監査ログを有効にし、その後監査フィルタールールを指定する必要があります。

> **Note:**
>
> 監査ログはクラスターリソースを消費するため、クラスターを監査するかどうかを慎重に検討してください。

## 前提条件 {#prerequisites}

- TiDB Dedicatedクラスターを使用していること。TiDB Serverlessクラスターでは監査ログは利用できません。
- 組織の`Organization Owner`または`Project Owner`の役割にいること。そうでない場合、TiDB Cloudコンソールでデータベース監査に関連するオプションを表示することはできません。詳細については、[ユーザーの役割](/tidb-cloud/manage-user-access.md#user-roles)を参照してください。

## AWSまたはGoogle Cloudの監査ログの有効化 {#enable-audit-logging-for-aws-or-google-cloud}

TiDB Cloudが監査ログをクラウドバケットに書き込むためには、まず監査ログを有効にする必要があります。

### AWSの監査ログの有効化 {#enable-audit-logging-for-aws}

AWSの監査ログを有効にするには、以下の手順を実行してください。

#### ステップ1. Amazon S3バケットの作成 {#step-1-create-an-amazon-s3-bucket}

企業所有のAWSアカウント内のAmazon S3バケットを指定し、TiDB Cloudが監査ログを書き込む宛先としてください。

詳細については、AWSユーザーガイドの[バケットの作成](https://docs.aws.amazon.com/AmazonS3/latest/userguide/create-bucket-overview.html)を参照してください。

#### ステップ2. Amazon S3アクセスの構成 {#step-2-configure-amazon-s3-access}

> **Note:**
>
> 1つのプロジェクト内の1つのクラスターに対してAmazon S3アクセス構成が行われた場合、同じバケットをプロジェクト内のすべてのクラスターの監査ログの宛先として使用できます。

1. TiDB CloudアカウントIDと、監査ログを有効にしたいTiDBクラスターのExternal IDを取得します。

   1. TiDB Cloudコンソールで、AWSに展開されたプロジェクトとクラスターを選択します。
   2. **設定** > **監査設定**を選択します。**監査ログ**ダイアログが表示されます。
   3. **監査ログ**ダイアログで、**AWS IAMポリシー設定を表示**をクリックします。対応するTiDB CloudアカウントIDとTiDBクラスターのExternal IDが表示されます。
   4. 後で使用するために、TiDB CloudアカウントIDとExternal IDを記録します。

2. AWS Management Consoleで、**IAM** > **アクセス管理** > **ポリシー**に移動し、`s3:PutObject`の書き込み専用権限を持つストレージバケットポリシーが存在するかどうかを確認します。

   - ある場合は、後で使用するために一致するストレージバケットポリシーを記録します。
   - ない場合は、**IAM** > **アクセス管理** > **ポリシー** > **ポリシーの作成**に移動し、次のポリシーテンプレートに従ってバケットポリシーを定義します。

     ```json
     {
         "Version": "2012-10-17",
         "Statement": [
             {
                 "Effect": "Allow",
                 "Action": "s3:PutObject",
                 "Resource": "<Your S3 bucket ARN>/*"
             }
         ]
     }
     ```

     テンプレートでは、`<Your S3 bucket ARN>`は監査ログファイルが書き込まれるS3バケットのAmazonリソース名（ARN）です。S3バケットの**プロパティ**タブに移動し、**バケットの概要**エリアでARNの値を取得できます。`"Resource"`フィールドでは、ARNの後に`/*`を追加する必要があります。たとえば、ARNが`arn:aws:s3:::tidb-cloud-test`の場合、`"Resource"`フィールドの値を`"arn:aws:s3:::tidb-cloud-test/*"`に構成する必要があります。

3. **IAM** > **アクセス管理** > **ロール**に移動し、以前に記録したTiDB CloudアカウントIDとExternal IDに対応する信頼エンティティのロールが既に存在するかどうかを確認します。

   - ある場合は、後で使用するために一致するロールを記録します。
   - ない場合は、**ロールの作成**をクリックし、信頼エンティティタイプとして**別のAWSアカウント**を選択し、**アカウントID**フィールドにTiDB CloudアカウントIDの値を入力します。その後、**外部IDを要求**オプションを選択し、**外部ID**フィールドにTiDB Cloud External IDの値を入力します。

4. **IAM** > **アクセス管理** > **ロール**で、前の手順で作成したロール名をクリックして**概要**ページに移動し、次の手順を実行します。

   1. **アクセス許可**タブで、`s3:PutObject`の書き込み専用権限を持つポリシーがロールにアタッチされているかどうかを確認します。そうでない場合は、**ポリシーのアタッチ**を選択し、必要なポリシーを検索してから**ポリシーのアタッチ**をクリックします。
   2. **概要**ページに戻り、**ロールARN**の値をクリップボードにコピーします。

#### ステップ3. 監査ログの有効化 {#step-3-enable-audit-logging}

TiDB Cloudコンソールで、TiDB CloudアカウントIDとExternal IDの値を取得した**監査ログ**ダイアログボックスに戻り、次の手順を実行します。

1. **バケットURI**フィールドに、監査ログファイルが書き込まれるS3バケットのURIを入力します。

2. **バケットリージョン**のドロップダウンリストから、バケットの場所に応じたAWSリージョンを選択します。

3. **ロールARN**フィールドに、[ステップ2. Amazon S3アクセスの構成](#step-2-configure-amazon-s3-access)でコピーしたロールARNの値を入力します。

4. **接続のテスト**をクリックして、TiDB Cloudがバケットにアクセスして書き込むことができるかどうかを検証します。

   成功した場合、**Pass**が表示されます。それ以外の場合は、アクセス構成を確認してください。

5. 右上隅で、監査設定を**オン**に切り替えます。

   TiDB Cloudは指定されたクラスターの監査ログをAmazon S3バケットに書き込む準備ができています。

> **Note:**
>
> - 監査ログを有効にした後、バケットURI、場所、またはARNに新しい変更を加えた場合は、**再起動**をクリックして変更を読み込み、**接続のテスト**を再実行して変更を有効にする必要があります。
> - TiDB CloudからAmazon S3アクセスを削除するには、追加した信頼ポリシーを単純に削除するだけです。

### Google Cloudの監査ログの有効化 {#enable-audit-logging-for-google-cloud}

Google Cloudの監査ログを有効にするには、以下の手順を実行してください。

#### ステップ1. GCSバケットの作成 {#step-1-create-a-gcs-bucket}

企業所有のGoogle Cloudアカウント内のGoogle Cloud Storage（GCS）バケットを指定し、TiDB Cloudが監査ログを書き込む宛先としてください。

詳細については、Google Cloud Storageドキュメントの[ストレージバケットの作成](https://cloud.google.com/storage/docs/creating-buckets)を参照してください。

#### ステップ2. GCSアクセスの構成 {#step-2-configure-gcs-access}

> **Note:**
>
> 1つのプロジェクト内の1つのクラスターに対してGCSアクセス構成が行われた場合、同じバケットをプロジェクト内のすべてのクラスターの監査ログの宛先として使用できます。

1. 監査ログを有効にしたいTiDBクラスターのGoogle CloudサービスアカウントIDを取得します。

   1. TiDB Cloudコンソールで、Google Cloud Platformに展開されたプロジェクトとクラスターを選択します。
   2. **設定** > **監査設定**を選択します。**監査ログ**ダイアログボックスが表示されます。
   3. **Google CloudサービスアカウントIDを表示**をクリックし、後で使用するためにサービスアカウントIDをコピーします。

2. Google Cloudコンソールで、**IAM＆管理** > **ロール**に移動し、ストレージコンテナの次の書き込み専用権限を持つロールが存在するかどうかを確認します。

   - storage.objects.create
   - storage.objects.delete

   ある場合は、後で使用するためにTiDBクラスターの一致するロールを記録します。ない場合は、**IAM＆管理** > **ロール** > **ロールの作成**に移動し、TiDBクラスターのためにロールを定義します。

3. **Cloud Storage** > **ブラウザ**に移動し、TiDB CloudがアクセスするGCSバケットを選択し、**情報パネルを表示**をクリックします。

   パネルが表示されます。

4. パネルで、**主体の追加**をクリックします。

   主体の追加のダイアログボックスが表示されます。

5. ダイアログボックスで、次の手順を実行します。

   1. **新しい主体**フィールドに、TiDBクラスターのGoogle CloudサービスアカウントIDを貼り付けます。
   2. **ロール**のドロップダウンリストから、対象のTiDBクラスターのロールを選択します。
   3. **保存**をクリックします。

#### ステップ3. 監査ログを有効にする {#step-3-enable-audit-logging}

TiDB Cloudコンソールで、TiDB CloudアカウントIDを取得した**監査ログ**ダイアログボックスに戻り、次の手順を実行します。

1. **Bucket URI**フィールドに、完全なGCSバケット名を入力します。

2. **Bucket Region**フィールドで、バケットの場所に対応するGCSリージョンを選択します。

3. **Test Connectivity**をクリックして、TiDB Cloudがバケットにアクセスして書き込めるかどうかを確認します。

   成功した場合、**Pass**が表示されます。それ以外の場合は、アクセス構成を確認してください。

4. 右上隅にある監査設定を**On**に切り替えます。

   TiDB Cloudは、指定されたクラスターの監査ログをAmazon S3バケットに書き込む準備ができています。

> **Note:**
>
> - 監査ログを有効にした後、バケットURIまたは場所に新しい変更を加えると、変更を読み込み**Test Connectivity**を再実行して変更を有効にするために**Restart**をクリックする必要があります。
> - TiDB CloudからGCSへのアクセスを削除するには、追加したプリンシパルを単純に削除します。

## 監査フィルタールールを指定する {#specify-auditing-filter-rules}

監査ログを有効にした後、ユーザーアクセスイベントをキャプチャして監査ログに書き込むか、無視するかを制御する監査フィルタールールを指定する必要があります。フィルタールールが指定されていない場合、TiDB Cloudは何も記録しません。

クラスターの監査フィルタールールを指定するには、次の手順を実行します。

1. 監査ログを有効にした**監査ログ**ダイアログボックスで、下にスクロールして**Filter Rules**セクションを見つけます。
2. 1つのルールにつき1行で、各ルールがユーザー式、データベース式、テーブル式、およびアクセスタイプを指定するように、1つ以上のフィルタールールを追加します。

> **Note:**
>
> - フィルタールールは正規表現であり、大文字と小文字が区別されます。ワイルドカードルール`.*`を使用すると、クラスター内のすべてのユーザー、データベース、またはテーブルイベントが記録されます。
> - 監査ログはクラスターリソースを消費するため、フィルタールールを指定する際は慎重に行ってください。消費を最小限に抑えるために、可能な限り特定のデータベースオブジェクト、ユーザー、およびアクションに監査ログの範囲を制限するフィルタールールを指定することをお勧めします。

## 監査ログの表示 {#view-audit-logs}

TiDB Cloud監査ログは、クラスターID、Pod ID、およびログ作成日が完全修飾ファイル名に組み込まれた読み取り可能なテキストファイルです。

例えば、`13796619446086334065/tidb-0/tidb-audit-2022-04-21T18-16-29.529.log`。この例では、`13796619446086334065`はクラスターIDを示し、`tidb-0`はPod IDを示します。

## 監査ログの無効化 {#disable-audit-logging}

クラスターの監査を行いたくない場合は、クラスターのページに移動し、**Settings** > **Audit Settings**をクリックし、右上隅にある監査設定を**Off**に切り替えます。

> **Note:**
>
> ログファイルのサイズが10 MiBに達するたびに、ログファイルはクラウドストレージバケットにプッシュされます。したがって、監査ログが無効になった後、サイズが10 MiB未満のログファイルは自動的にクラウドストレージバケットにプッシュされません。この状況でログファイルを取得するには、[PingCAPサポート](/tidb-cloud/tidb-cloud-support.md)に連絡してください。

## 監査ログフィールド {#audit-log-fields}

監査ログのデータベースイベントレコードごとに、TiDBは次のフィールドを提供します。

> **Note:**
>
> 以下の表では、フィールドの空の最大長さとは、このフィールドのデータ型が定義済みの定数長（例: INTEGERの場合は4バイト）を持つことを意味します。

| Col # | フィールド名          | TiDBデータ型  | 最大長   | 説明                                |
| ----- | --------------- | --------- | ----- | --------------------------------- |
| 1     | N/A             | N/A       | N/A   | 内部使用のために予約されています                  |
| 2     | N/A             | N/A       | N/A   | 内部使用のために予約されています                  |
| 3     | N/A             | N/A       | N/A   | 内部使用のために予約されています                  |
| 4     | ID              | INTEGER   |       | ユニークなイベントID                       |
| 5     | TIMESTAMP       | TIMESTAMP |       | イベントの時間                           |
| 6     | EVENT\_CLASS    | VARCHAR   | 15    | イベントタイプ                           |
| 7     | EVENT\_SUBCLASS | VARCHAR   | 15    | イベントサブタイプ                         |
| 8     | STATUS\_CODE    | INTEGER   |       | ステートメントの応答ステータス                   |
| 9     | COST\_TIME      | FLOAT     |       | ステートメントによって消費される時間                |
| 10    | HOST            | VARCHAR   | 16    | サーバーIP                            |
| 11    | CLIENT\_IP      | VARCHAR   | 16    | クライアントIP                          |
| 12    | USER            | VARCHAR   | 17    | ログインユーザー名                         |
| 13    | DATABASE        | VARCHAR   | 64    | イベント関連のデータベース                     |
| 14    | TABLES          | VARCHAR   | 64    | イベント関連のテーブル名                      |
| 15    | SQL\_TEXT       | VARCHAR   | 64 KB | マスクされたSQLステートメント                  |
| 16    | ROWS            | INTEGER   |       | 影響を受ける行の数（`0`は行が影響を受けていないことを示します） |

TiDBによって設定されたEVENT\_CLASSフィールドの値に応じて、監査ログのデータベースイベントレコードには以下の追加フィールドも含まれます。

- EVENT\_CLASSの値が`CONNECTION`の場合、データベースイベントレコードには以下のフィールドも含まれます:

  | Col # | フィールド名                  | TiDBデータ型 | 最大長 | 説明                                           |
  | ----- | ----------------------- | -------- | --- | -------------------------------------------- |
  | 17    | CLIENT\_PORT            | INTEGER  |     | クライアントポート番号                                  |
  | 18    | CONNECTION\_ID          | INTEGER  |     | 接続ID                                         |
  | 19    | CONNECTION\_TYPE        | VARCHAR  | 12  | `socket`または`unix-socket`を介した接続               |
  | 20    | SERVER\_ID              | INTEGER  |     | TiDBサーバーID                                   |
  | 21    | SERVER\_PORT            | INTEGER  |     | TiDBサーバーがMySQLプロトコルを介してクライアントと通信するために使用するポート |
  | 22    | SERVER\_OS\_LOGIN\_USER | VARCHAR  | 17  | TiDBプロセス起動システムのユーザー名                         |
  | 23    | OS\_VERSION             | VARCHAR  | N/A | TiDBサーバーが配置されているオペレーティングシステムのバージョン           |
  | 24    | SSL\_VERSION            | VARCHAR  | 6   | TiDBの現在のSSLバージョン                             |
  | 25    | PID                     | INTEGER  |     | TiDBプロセスのPID                                 |

- EVENT\_CLASSの値が`TABLE_ACCESS`または`GENERAL`の場合、データベースイベントレコードには以下のフィールドも含まれます:

  | Col # | フィールド名         | TiDBデータ型 | 最大長 | 説明                 |
  | ----- | -------------- | -------- | --- | ------------------ |
  | 17    | CONNECTION\_ID | INTEGER  |     | 接続ID               |
  | 18    | COMMAND        | VARCHAR  | 14  | MySQLプロトコルのコマンドタイプ |
  | 19    | SQL\_STATEMENT | VARCHAR  | 17  | SQLステートメントタイプ      |
  | 20    | PID            | INTEGER  |     | TiDBプロセスのPID       |
