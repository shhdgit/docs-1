---
title: Database Audit Logging
summary: Learn about how to audit a cluster in TiDB Cloud.
---

# データベース監査ログ {#database-audit-logging}

TiDB Cloudは、ログにユーザーアクセスの詳細（実行されたSQLステートメントなど）の履歴を記録するデータベース監査ログ機能を提供します。

> **Note:**
>
> 現在、データベース監査ログ機能はリクエストによりのみ利用可能です。この機能をリクエストするには、[TiDB Cloudコンソール](https://tidbcloud.com)の右下の\*\*?\*\*をクリックし、**サポートリクエスト**をクリックします。次に、**説明**フィールドに「データベース監査ログの申請」と入力し、**送信**をクリックします。

組織のユーザーアクセスポリシーやその他の情報セキュリティ対策の効果を評価するために、定期的にデータベース監査ログを分析することはセキュリティ上のベストプラクティスです。

監査ログ機能はデフォルトで無効になっています。クラスターを監査するには、まず監査ログを有効にし、次に監査フィルタールールを指定する必要があります。

> **Note:**
>
> 監査ログはクラスターリソースを消費するため、クラスターを監査するかどうかは慎重に検討してください。

## 前提条件 {#prerequisites}

- TiDB Dedicatedクラスターを使用しています。TiDB Serverlessクラスターでは監査ログを利用できません。
- 組織の`所有者`または`プロジェクトの所有者`の役割を持っています。そうでない場合、TiDB Cloudコンソールでデータベース監査に関するオプションを表示することができません。詳細については、[ユーザーの役割](/tidb-cloud/manage-user-access.md#user-roles)を参照してください。

## AWSまたはGoogle Cloudでの監査ログの有効化 {#enable-audit-logging-for-aws-or-google-cloud}

TiDB Cloudが監査ログをクラウドバケットに書き込めるようにするには、まず監査ログを有効にする必要があります。

### AWSでの監査ログの有効化 {#enable-audit-logging-for-aws}

AWSで監査ログを有効にするには、次の手順を実行します。

#### ステップ1. Amazon S3バケットの作成 {#step-1-create-an-amazon-s3-bucket}

TiDB Cloudが監査ログを書き込むための宛先として、企業所有のAWSアカウントでAmazon S3バケットを指定します。

詳細については、AWSユーザーガイドの[バケットの作成](https://docs.aws.amazon.com/AmazonS3/latest/userguide/create-bucket-overview.html)を参照してください。

#### ステップ2. Amazon S3アクセスの設定 {#step-2-configure-amazon-s3-access}

> **Note:**
>
> プロジェクト内の1つのクラスターでAmazon S3アクセスの設定を行うと、同じバケットをプロジェクト内のすべてのクラスターの監査ログの宛先として使用できます。

1. TiDB CloudアカウントIDと有効にするTiDBクラスターの外部IDを取得します。

   1. TiDB Cloudコンソールで、プロジェクトとAWSでデプロイされたクラスターを選択します。
   2. **設定** > **監査設定**を選択します。**監査ログ**ダイアログが表示されます。
   3. **監査ログ**ダイアログで、**AWS IAMポリシー設定を表示**をクリックします。対応するTiDB CloudアカウントIDとTiDB Cloudクラスターの外部IDが表示されます。
   4. 後で使用するために、TiDB CloudアカウントIDと外部IDを記録します。

2. AWS Management Consoleで、**IAM** > **アクセス管理** > **ポリシー**に移動し、`s3:PutObject`の書き込み専用権限を持つストレージバケットポリシーがあるかどうかを確認します。

   - ある場合は、後で使用するために一致するストレージバケットポリシーを記録します。
   - ない場合は、**IAM** > **アクセス管理** > **ポリシー** > **ポリシーの作成**に移動し、次のポリシーテンプレートに従ってバケットポリシーを定義します。

     ```json
     {
         "Version": "2012-10-17",
         "Statement": [
             {
                 "Effect": "Allow",
                 "Action": "s3:PutObject",
                 "Resource": "<Your S3 bucket ARN>/*"
             }
         ]
     }
     ```

     テンプレートでは、`<Your S3 bucket ARN>`は監査ログファイルが書き込まれるS3バケットのAmazon Resource Name（ARN）です。S3バケットの**プロパティ**タブに移動し、**バケットの概要**エリアでARN値を取得できます。`"Resource"`フィールドには、ARNの後に`/*`を追加する必要があります。たとえば、ARNが`arn:aws:s3:::tidb-cloud-test`の場合、`"Resource"`フィールドの値を`"arn:aws:s3:::tidb-cloud-test/*"`に設定する必要があります。

3. **IAM** > **アクセス管理** > **ロール**に移動し、以前に記録したTiDB CloudアカウントIDと外部IDに対応する信頼エンティティのロールがすでに存在するかどうかを確認します。

   - ある場合は、後で使用するために一致するロールを記録します。
   - ない場合は、**ロールの作成**をクリックし、信頼エンティティタイプとして**別のAWSアカウント**を選択し、**アカウントID**フィールドにTiDB CloudアカウントIDの値を入力します。次に、**外部ID**フィールドにTiDB Cloud外部IDの値を入力し、**外部IDを要求する**オプションを選択します。

4. **IAM** > **アクセス管理** > **ロール**で、前のステップで作成したロール名をクリックして**概要**ページに移動し、次の手順を実行します。

   1. **アクセス権限**タブで、`s3:PutObject`の書き込み専用権限を持つ記録されたポリシーがロールにアタッチされているかどうかを確認します。そうでない場合は、**ポリシーのアタッチ**を選択し、必要なポリシーを検索し、**ポリシーのアタッチ**をクリックします。
   2. **概要**ページに戻り、**ロールARN**の値をクリップボードにコピーします。

#### ステップ3. 監査ログの有効化 {#step-3-enable-audit-logging}

TiDB Cloudコンソールで、TiDB CloudアカウントIDと外部IDの値を取得した**監査ログ**ダイアログボックスに戻り、次の手順を実行します。

1. **バケットURI**フィールドに、監査ログファイルが書き込まれるS3バケットのURIを入力します。

2. **バケットリージョン**のドロップダウンリストで、バケットがあるAWSリージョンを選択します。

3. **ロールARN**フィールドに、[ステップ2. Amazon S3アクセスの構成](#step-2-configure-amazon-s3-access)でコピーしたロールARNの値を入力します。

4. **接続をテスト**をクリックして、TiDB Cloudがバケットにアクセスして書き込みできるかどうかを確認します。

   成功した場合、**パス**が表示されます。それ以外の場合は、アクセス構成を確認してください。

5. 右上隅で、監査設定を**オン**に切り替えます。

   TiDB Cloudは、指定したクラスターの監査ログをAmazon S3バケットに書き込む準備ができています。

> **Note:**
>
> - 監査ログを有効にした後、バケットURI、場所、またはARNに新しい変更を加える場合は、**再起動**をクリックして変更をロードし、**接続をテスト**チェックを再実行して変更を有効にする必要があります。
> - TiDB CloudからAmazon S3へのアクセスを削除するには、追加した信頼ポリシーを削除するだけです。

### Google Cloudの監査ログの有効化 {#enable-audit-logging-for-google-cloud}

Google Cloudの監査ログを有効にするには、次の手順を実行します。

#### ステップ1. GCSバケットの作成 {#step-1-create-a-gcs-bucket}

TiDB Cloudのコーポレート所有のGoogle Cloudアカウントで、TiDB Cloudが監査ログを書き込むための宛先としてGoogle Cloud Storage（GCS）バケットを指定します。

詳細については、Google Cloud Storageドキュメントの[ストレージバケットの作成](https://cloud.google.com/storage/docs/creating-buckets)を参照してください。

#### ステップ2. GCSアクセスの構成 {#step-2-configure-gcs-access}

> **Note:**
>
> プロジェクト内の1つのクラスターでGCSアクセス構成を実行すると、同じバケットをプロジェクト内のすべてのクラスターの監査ログの宛先として使用できます。

1. 監査ログを有効にするTiDBクラスターのGoogle CloudサービスアカウントIDを取得します。

   1. TiDB Cloudコンソールで、プロジェクトとGoogle Cloud Platformにデプロイされたクラスターを選択します。
   2. **設定** > **監査設定**を選択します。**監査ログ**ダイアログボックスが表示されます。
   3. **Google CloudサービスアカウントIDを表示**をクリックし、後で使用するためにサービスアカウントIDをコピーします。

2. Google Cloudコンソールで、**IAM & Admin** > **Roles**に移動し、次の書き込み専用のストレージコンテナの権限を持つロールが存在するかどうかを確認します。

   - storage.objects.create
   - storage.objects.delete

   ある場合は、一致するロールを後で使用するために記録します。そうでない場合は、**IAM & Admin** > **Roles** > **CREATE ROLE**に移動し、TiDBクラスターのためのロールを定義します。

3. **Cloud Storage** > **Browser**に移動し、TiDB CloudがアクセスするGCSバケットを選択し、**SHOW INFO PANEL**をクリックします。

   パネルが表示されます。

4. パネルで、**ADD PRINCIPAL**をクリックします。

   プリンシパルを追加するためのダイアログボックスが表示されます。

5. ダイアログボックスで、次の手順を実行します。

   1. **New Principals**フィールドに、TiDBクラスターのGoogle CloudサービスアカウントIDを貼り付けます。
   2. **Role**ドロップダウンリストで、対象のTiDBクラスターのロールを選択します。
   3. **SAVE**をクリックします。

#### ステップ3. 監査ログの有効化 {#step-3-enable-audit-logging}

TiDB Cloudコンソールで、TiDB CloudアカウントIDを取得した**監査ログ**ダイアログボックスに戻り、次の手順を実行します。

1. **Bucket URI**フィールドに、完全なGCSバケット名を入力します。

2. **Bucket Region**フィールドで、バケットがあるGCSリージョンを選択します。

3. **Test Connectivity**をクリックして、TiDB Cloudがバケットにアクセスして書き込みを行えるかどうかを検証します。

   成功した場合、**Pass**が表示されます。それ以外の場合は、アクセス構成を確認してください。

4. 右上隅で、監査設定を**On**に切り替えます。

   TiDB Cloudは、指定したクラスターの監査ログをAmazon S3バケットに書き込む準備ができています。

> **Note:**
>
> - 監査ログを有効にした後、バケットURIまたは場所に新しい変更を加える場合は、**Restart**をクリックして変更をロードし、**Test Connectivity**チェックを再実行して変更を有効にする必要があります。
> - TiDB CloudからGCSアクセスを削除するには、追加したプリンシパルを単に削除します。

## 監査フィルタールールの指定 {#specify-auditing-filter-rules}

監査ログを有効にした後、監査フィルタールールを指定して、キャプチャして監査ログに書き込むユーザーアクセスイベントと無視するイベントを制御する必要があります。フィルタールールが指定されていない場合、TiDB Cloudは何もログを記録しません。

クラスターの監査フィルタールールを指定するには、次の手順を実行します。

1. 監査ログを有効にする**監査ログ**ダイアログボックスで、下にスクロールして**Filter Rules**セクションを見つけます。
2. 1つのフィルタールールにつき1行ずつ、ユーザー式、データベース式、テーブル式、およびアクセスタイプを指定して、1つ以上のフィルタールールを追加します。

> **Note:**
>
> - フィルタールールは正規表現であり、大文字と小文字を区別します。ワイルドカードルール`.*`を使用すると、クラスターのすべてのユーザー、データベース、またはテーブルイベントがログに記録されます。
> - 監査ログはクラスターリソースを消費するため、フィルタールールを指定する際は慎重に行ってください。可能な限り、特定のデータベースオブジェクト、ユーザー、およびアクションの範囲を制限するためにフィルタールールを指定することをお勧めします。

## 監査ログの表示 {#view-audit-logs}

TiDB Cloudの監査ログは、クラスターID、Pod ID、およびログ作成日が完全修飾ファイル名に組み込まれている読み取り可能なテキストファイルです。

例えば、`13796619446086334065/tidb-0/tidb-audit-2022-04-21T18-16-29.529.log`です。この例では、`13796619446086334065`はクラスターIDを示し、`tidb-0`はPod IDを示します。

## 監査ログの無効化 {#disable-audit-logging}

クラスターの監査をもう行いたくない場合は、クラスターのページに移動し、**設定** > **監査設定**をクリックし、右上隅の監査設定を**オフ**に切り替えます。

> **Note:**
>
> ログファイルのサイズが10 MiBに達するたびに、ログファイルはクラウドストレージバケットにプッシュされます。そのため、監査ログが無効になった後、サイズが10 MiB未満のログファイルは自動的にクラウドストレージバケットにプッシュされません。このような状況でログファイルを取得するには、[PingCAPサポート](/tidb-cloud/tidb-cloud-support.md)にお問い合わせください。

## 監査ログフィールド {#audit-log-fields}

監査ログの各データベースイベントレコードに対して、TiDBは次のフィールドを提供します。

> **Note:**
>
> 以下の表では、フィールドの空の最大長さは、このフィールドのデータ型が定数長を持つことを意味します（例えば、INTEGERの場合は4バイト）。

| Col # | フィールド名          | TiDBデータ型  | 最大長さ  | 説明                           |
| ----- | --------------- | --------- | ----- | ---------------------------- |
| 1     | N/A             | N/A       | N/A   | 内部使用のために予約されています             |
| 2     | N/A             | N/A       | N/A   | 内部使用のために予約されています             |
| 3     | N/A             | N/A       | N/A   | 内部使用のために予約されています             |
| 4     | ID              | INTEGER   |       | ユニークなイベントID                  |
| 5     | TIMESTAMP       | TIMESTAMP |       | イベントの時刻                      |
| 6     | EVENT\_CLASS    | VARCHAR   | 15    | イベントタイプ                      |
| 7     | EVENT\_SUBCLASS | VARCHAR   | 15    | イベントサブタイプ                    |
| 8     | STATUS\_CODE    | INTEGER   |       | ステートメントのレスポンスステータス           |
| 9     | COST\_TIME      | FLOAT     |       | ステートメントによって消費される時間           |
| 10    | HOST            | VARCHAR   | 16    | サーバーIP                       |
| 11    | CLIENT\_IP      | VARCHAR   | 16    | クライアントIP                     |
| 12    | USER            | VARCHAR   | 17    | ログインユーザー名                    |
| 13    | DATABASE        | VARCHAR   | 64    | イベントに関連するデータベース              |
| 14    | TABLES          | VARCHAR   | 64    | イベントに関連するテーブル名               |
| 15    | SQL\_TEXT       | VARCHAR   | 64 KB | マスクされたSQLステートメント             |
| 16    | ROWS            | INTEGER   |       | 影響を受ける行数（`0`は影響を受けないことを示します） |

TiDBによって設定されたEVENT\_CLASSフィールドの値に応じて、監査ログのデータベースイベントレコードには、次のような追加フィールドも含まれます。

- もしEVENT\_CLASSの値が`CONNECTION`であれば、データベースのイベントレコードには以下のフィールドも含まれます：

  | Col # | Field name              | TiDB data type | Maximum length | Description                                  |
  | ----- | ----------------------- | -------------- | -------------- | -------------------------------------------- |
  | 17    | CLIENT\_PORT            | INTEGER        |                | クライアントのポート番号                                 |
  | 18    | CONNECTION\_ID          | INTEGER        |                | コネクションID                                     |
  | 19    | CONNECTION\_TYPE        | VARCHAR        | 12             | `socket`または`unix-socket`を介してのコネクション          |
  | 20    | SERVER\_ID              | INTEGER        |                | TiDBサーバーID                                   |
  | 21    | SERVER\_PORT            | INTEGER        |                | MySQLプロトコルを介してクライアントと通信するためにTiDBサーバーが使用するポート |
  | 22    | SERVER\_OS\_LOGIN\_USER | VARCHAR        | 17             | TiDBプロセスの起動システムのユーザー名                        |
  | 23    | OS\_VERSION             | VARCHAR        | N/A            | TiDBサーバーが配置されているオペレーティングシステムのバージョン           |
  | 24    | SSL\_VERSION            | VARCHAR        | 6              | TiDBの現在のSSLバージョン                             |
  | 25    | PID                     | INTEGER        |                | TiDBプロセスのPID                                 |

- もしEVENT\_CLASSの値が`TABLE_ACCESS`または`GENERAL`であれば、データベースのイベントレコードには以下のフィールドも含まれます：

  | Col # | Field name     | TiDB data type | Maximum length | Description        |
  | ----- | -------------- | -------------- | -------------- | ------------------ |
  | 17    | CONNECTION\_ID | INTEGER        |                | コネクションID           |
  | 18    | COMMAND        | VARCHAR        | 14             | MySQLプロトコルのコマンドタイプ |
  | 19    | SQL\_STATEMENT | VARCHAR        | 17             | SQLステートメントタイプ      |
  | 20    | PID            | INTEGER        |                | TiDBプロセスのPID       |
