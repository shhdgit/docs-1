---
title: Physical Import Mode
summary: Learn about the physical import mode in TiDB Lightning.
---

# 物理インポートモード {#physical-import-mode}

物理インポートモードは、SQLインターフェースを介さずに、TiKVノードに直接キーと値のペアとしてデータを挿入する効率的で高速なインポートモードです。物理インポートモードを使用すると、単一のLightningインスタンスで最大10 TiBのデータをインポートすることができます。理論的には、Lightningインスタンスの数が増えるにつれて、インポートされるデータの量も増加します。ユーザーによって、Lightningに基づく[並列インポート](/tidb-lightning/tidb-lightning-distributed-import.md)は、効率的に最大50 TiBのデータを処理できることが確認されています。

物理インポートモードを使用する前に、[要件と制限事項](#requirements-and-restrictions)を必ずお読みください。

物理インポートモードのバックエンドは`local`です。`tidb-lightning.toml`で変更することができます：

```toml
[tikv-importer]
# Set the import mode to "local" to use the physical import mode.
backend = "local"
```

## 実装 {#implementation}

1. データをインポートする前に、TiDB Lightningは自動的にTiKVノードを「インポートモード」に切り替え、書き込みパフォーマンスを向上させ、自動コンパクションを停止します。TiDB Lightningは、TiDB Lightningのバージョンに応じて、グローバルスケジューリングを一時停止するかどうかを判断します。

   - v7.1.0以降、TiDB Lightningパラメーター[`pause-pd-scheduler-scope`](/tidb-lightning/tidb-lightning-configuration.md)を使用して、スケジューリングを一時停止する範囲を制御できます。
   - TiDB Lightningのバージョンがv6.2.0からv7.0.0の場合、グローバルスケジューリングを一時停止するかどうかの動作は、TiDBクラスターのバージョンによって異なります。TiDBクラスターがv6.1.0以上の場合、TiDB Lightningはターゲットテーブルデータを格納するリージョンのスケジューリングを一時停止します。インポートが完了すると、TiDB Lightningはスケジューリングを回復します。その他のバージョンの場合、TiDB Lightningはグローバルスケジューリングを一時停止します。
   - TiDB Lightning < v6.2.0の場合、TiDB Lightningはグローバルスケジューリングを一時停止します。

2. TiDB Lightningは、ターゲットデータベースでテーブルスキーマを作成し、メタデータを取得します。

   `add-index-by-sql`を`true`に設定すると、`tidb-lightning`はSQLインターフェースを介してインデックスを追加し、データをインポートする前にターゲットテーブルからすべての二次インデックスを削除します。デフォルト値は`false`で、以前のバージョンと一致します。

3. 各テーブルは複数の連続した**ブロック**に分割され、TiDB Lightningは大きなテーブル（200 GB以上）からデータを並列にインポートできます。

4. TiDB Lightningは、キーと値のペアを処理するための「エンジンファイル」を各ブロックに準備します。TiDB LightningはSQLダンプを並列に読み取り、データソースをTiDBと同じエンコーディングのキーと値のペアに変換し、キーと値のペアをソートしてローカルの一時ストレージファイルに書き込みます。

5. エンジンファイルが書き込まれると、TiDB LightningはターゲットTiKVクラスターでデータを分割してスケジュールし、TiKVクラスターにデータをインポートします。

   エンジンファイルには、**データエンジン**と**インデックスエンジン**の2種類のエンジンが含まれます。各エンジンは、行データと二次インデックスのタイプのキーと値のペアに対応します。通常、行データはデータソースで完全に順序付けられており、二次インデックスは順序付けられていません。そのため、データエンジンファイルは、対応するブロックが書き込まれた直後にインポートされ、すべてのインデックスエンジンファイルは、テーブル全体がエンコードされた後にインポートされます。

   `tidb-lightning`がSQLインターフェースを介してインデックスを追加する場合（つまり、`add-index-by-sql`を`true`に設定する場合）、インデックスエンジンはデータを書き込みません。なぜなら、ターゲットテーブルの二次インデックスはステップ2で既に削除されているからです。

6. すべてのエンジンファイルがインポートされた後、TiDB Lightningはローカルのデータソースとダウンストリームクラスターのチェックサムを比較し、インポートされたデータが破損していないことを確認します。その後、TiDB Lightningはステップ2で以前に削除された二次インデックスを追加したり、新しいデータを解析するためにTiDBを実行したり（`ANALYZE`）、`tidb-lightning`は将来の操作を最適化します。同時に、`tidb-lightning`は将来の競合を防ぐために`AUTO_INCREMENT`の値を調整します。

   自動インクリメントIDは、行数の**上限**を推定し、テーブルデータファイルの合計サイズに比例します。そのため、自動インクリメントIDは通常、実際の行数よりも大きくなります。これは正常です。なぜなら、自動インクリメントIDは[必ずしも連続しているとは限らない](/mysql-compatibility.md#auto-increment-id)からです。

7. すべてのステップが完了すると、TiDB Lightningは自動的にTiKVノードを「通常モード」に切り替えます。グローバルスケジューリングが一時停止されている場合、TiDB Lightningはグローバルスケジューリングも回復します。その後、TiDBクラスターは通常どおりサービスを提供できます。

## 要件と制限 {#requirements-and-restrictions}

### 環境要件 {#environment-requirements}

**オペレーティングシステム**：

新しいCentOS 7インスタンスを使用することをお勧めします。ローカルホストまたはクラウド上に仮想マシンをデプロイできます。TiDB Lightningはデフォルトで必要なだけのCPUリソースを消費するため、専用サーバーにデプロイすることをお勧めします。これが不可能な場合は、他のTiDBコンポーネント（たとえばtikv-server）と一緒に単一のサーバーにデプロイし、`region-concurrency`を設定してTiDB LightningからのCPU使用率を制限することができます。通常、サイズを論理CPUの75%に設定できます。

**メモリとCPU**：

パフォーマンスを向上させるために、32コア以上のCPUと64 GiB以上のメモリを割り当てることをお勧めします。

> **Note:**
>
> 大量のデータをインポートする場合、1つの並列インポートは約2 GiBのメモリを消費します。総メモリ使用量は `region-concurrency * 2 GiB` になります。`region-concurrency` はデフォルトで論理CPUの数と同じです。もしメモリサイズ（GiB）がCPUの2倍未満であるか、インポート中にOOMが発生した場合は、OOMを回避するために `region-concurrency` を減らすことができます。

**ストレージ**: `sorted-kv-dir` 設定項目は、ソートされたキー値ファイルの一時ストレージディレクトリを指定します。ディレクトリは空である必要があり、ストレージスペースはインポートするデータセットのサイズよりも大きくなければなりません。インポートパフォーマンスを向上させるために、`data-source-dir` とは異なるディレクトリを使用し、ディレクトリに対してフラッシュストレージと排他的I/Oを使用することを推奨します。

**ネットワーク**: 10Gbpsイーサネットカードが推奨されます。

### バージョン要件 {#version-requirements}

- TiDB Lightning >= v4.0.3。
- TiDB >= v4.0.0。
- ターゲットのTiDBクラスタがv3.xまたはそれ以前の場合、データインポートを完了するためにImporter-backendを使用する必要があります。このモードでは、`tidb-lightning` はgRPCを介して解析されたキー値ペアを `tikv-importer` に送信し、`tikv-importer` はデータインポートを完了します。

### 制限事項 {#limitations}

- 本番のTiDBクラスタに直接データをインポートするために物理インポートモードを使用しないでください。これには重大なパフォーマンスの影響があります。そうする必要がある場合は、[テーブルレベルでスケジューリングを一時停止する](/tidb-lightning/tidb-lightning-physical-import-mode-usage.md#scope-of-pausing-scheduling-during-import)を参照してください。
- TiDBクラスタにレイテンシーに敏感なアプリケーションと低い並列度がある場合、物理インポートモードを使用してクラスタにデータをインポートしないでください。このモードはオンラインアプリケーションに重大な影響を与える可能性があります。
- デフォルトでは、複数のTiDB Lightningインスタンスを使用して同じTiDBクラスタにデータをインポートしないでください。代わりに[並列インポート](/tidb-lightning/tidb-lightning-distributed-import.md)を使用してください。
- 複数のTiDB Lightningを使用して同じターゲットクラスタにデータをインポートする場合、インポートモードを混在させないでください。つまり、物理インポートモードと論理インポートモードを同時に使用しないでください。
- データをインポートするプロセス中に、ターゲットテーブルでDDLおよびDML操作を実行しないでください。そうしないと、インポートが失敗するか、データが不整合になります。同時に、読み取り操作を実行することは推奨されません。読み取ったデータは不整合になる可能性があります。インポート操作が完了した後に読み取りおよび書き込み操作を実行できます。
- 単一のLightningプロセスは、最大で10 TBの単一のテーブルをインポートできます。並列インポートでは、最大で10のLightningインスタンスを使用できます。

### 他のコンポーネントとの使用方法のヒント {#tips-for-using-with-other-components}

- TiDB LightningをTiFlashと一緒に使用する場合は、次のことに注意してください。

  - テーブルにTiFlashレプリカを作成しているかどうかに関係なく、TiDB Lightningを使用してテーブルにデータをインポートできます。ただし、インポートには通常よりも長い時間がかかる可能性があります。インポート時間は、TiDB Lightningがデプロイされているサーバーのネットワーク帯域幅、TiFlashノードのCPUおよびディスク負荷、およびTiFlashレプリカの数に影響を受けます。

- TiDB Lightningの文字セット：

  - v5.4.0より前のTiDB Lightningでは、`charset=GBK`のテーブルをインポートできません。

- TiDB LightningをTiCDCと一緒に使用する場合は、次のことに注意してください。

  - TiCDCは、物理インポートモードで挿入されたデータをキャプチャできません。

- TiDB LightningをBRと一緒に使用する場合は、次のことに注意してください。

  - BRがTiDB Lightningでインポートされているテーブルのスナップショットをバックアップすると、それらのテーブルのバックアップデータが不整合になる可能性があります。
  - BRがAWS EBSボリュームスナップショットを使用してデータをバックアップすると、TiDB Lightningでデータをインポートできない場合があります。
  - 時間指定リカバリ（PITR）は、TiDB Lightningでインポートされたデータをバックアップできません。
